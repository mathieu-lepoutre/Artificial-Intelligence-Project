---
title: "markdown"
author: "Mathieu Lepoutre"
date: "28-11-2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(ggplot2)
library(keras)
library(readr)
library(data.table)
library(magrittr)
library(anytime)
library(reticulate)


use_python("C:\\Program Files\\Python37")
```

```{python}
import datetime
import csv
import pandas
from IPython.display import Image
```

## Predicting a ship's destination based on it's beginning's latitude and longitude.

Wouldn't it be great if we could predict a ship's destination ?

In this paper I try to taccle this challenge.

For input there is a huge unprocessed dataset containing a ship's ID and it's total trajectory. 
Because a ship's owner will sometimes cancel the beacon that the ship sends, the data isn't always that accurate.

What I try to do as a first challenge is two things. I made a paint picture to explain it visually.

When would an owner stop the beacon from sending location data ? if sleeping, or when it's docked. That's why I first split the dataset on a timedelta. 
When the ship hasn't transmitted in a couple of hours, you can be sure of it that he pulled the plug out of the beacon.

After this split you have a ship's trajectory that includes when it stops. But that's what I want to predict. To train my neural network I need to be sure
the data is in the correct format.

So after the first split on time, a second split needs to be made. This time it will be on speed. When a ship's speed is under a certain threshold, it most likely stopped. This threshold can't be zero, since there is always a bit of current. 


```{python}
unprocessed = pd.read_csv("schipsdataset.csv",sep=';')
```

```{python}
unprocessed.head(10)
```

This visually explains the steps I'm going to partake.
```{python}
Image(filename='preprocessing.png')
```

Changeable variables to alter the output file. If you believe the time delta when the owner puts off the beacon is shorter or longer, this can be 
adjusted here. The same with the speed variable.
```{python}
timedelta = 500000 #130uur
speedDelta = 2     #2 meter per seconde
```



```{python}
f = open("schipsdataset.csv")
```

```{python}
fileData = f.readlines()
List = []
outputList = []
```


```{python}
def getTime(tuple):
    return (tuple[0]*60) + tuple[1]
```



```{python}
data = []
for d in fileData:
    temp = d.replace(";",",")
    data.append(temp.split(","))
  
List.append(data[1])
```



```{python}
def splitList(List):
    if(len(List)<1):
        return 0
    newList = []
    newList.append(List[0])
    route = 1
    for i in range(1,len(List)):
        
        if(len(List[i]) > 7):
            if((not (List[i][7]=="") )and (not(newList[len(newList)-1][7] == "") )):
                if((not (List[i][7]=="NULL") )and (not(newList[len(newList)-1][7] == "NULL") )):
                    if(not (List[i][7].rstrip("\n") is None)):
                        if(not (newList[len(newList)-1][7].rstrip("\n") is None)):
                                speedDiff = int(List[i][7]) - int(newList[len(newList)-1][7])
                                if(speedDiff < speedDelta):
                                    newList.append(List[i])
                                else:
                                    d = []
                                    d.append(newList[0][0])
                                    d.append(route)
                                    route = route + 1
                                    d.append(newList[0][2] + "." +newList[0][3])
                                    d.append(newList[0][4] + "." +newList[0][5])
                                    
                                    d.append(newList[len(newList)-1][2] + "."+newList[len(newList)-1][3])
                                    d.append(newList[len(newList)-1][4] + "."+newList[len(newList)-1][5])
                                                                        
                                    
                                    time1 = datetime.datetime.strptime(newList[0][1], '%Y-%m-%d %H:%M:%S.%f')
                                    time2 = datetime.datetime.strptime(newList[len(newList)-1][1], '%Y-%m-%d %H:%M:%S.%f')
                                    timeDiff = time2 - time1
                                    tup = divmod(timeDiff.total_seconds(), 60)    
                                    d.append(getTime(tup))
                                    print(d)
                                    outputList.append(d)
                                    newList = []
                                    newList.append(List[i])
```



```{python}
for i in range(2,len(data)):
    time1 = datetime.datetime.strptime(List[len(List)-1][1], '%Y-%m-%d %H:%M:%S.%f')
    time2 = datetime.datetime.strptime(data[i][1], '%Y-%m-%d %H:%M:%S.%f')
    timeDiff = time2 - time1
    tup = divmod(timeDiff.total_seconds(), 60)
    if(getTime(tup) < timedelta):
        if(len(data[i])>7):
            List.append(data[i])
    else:
        splitList(List)
        List = []
        List.append(data[i])
```

```{python}
with open('output.csv', mode='w') as output_file:
    output_writer = csv.writer(output_file, delimiter=',', quotechar='"', quoting=csv.QUOTE_MINIMAL)
    for data in outputList:        
        output_writer.writerow(data)
```


```{python}
sdata = pd.read_csv("output.csv",sep=',',names=["shipid","routeid","startLongitude","startLatitude","endlongitude","endlatitude","timedelta"])
```



```{python}
sdata=sdata[sdata.timedelta!=0]
sdata=sdata[sdata.timedelta>0]
```

```{python}
sdata.head(10)
```

```{python}
sdata.to_csv(r'processeddata.csv',sep='\t', index=False)
```

The data has been preprocessed. 

Each ship's route is now a single row, with its ID, the start latitude and longitude, the end latitude and longitude and the time delta.

Now it's time to start exploring recurrent neural networks, and specifically long short term memory neural networks.

The goal is to predict a ship's position based on it's start data.

This can be archieved by training the model on the thousands of trajects that happened in the past.


```{r}
pdata <- fread("processeddata.csv")

dim(pdata)

str(pdata)

summary(pdata)

view(pdata)
```





```{r}
pdata$shipid %>% plot

```


```{r}
TRAIN_SIZE = 1500
MAX_TEST_SIZE = 2000


```


```{r}
pdata <- data.matrix(pdata[,-1])
train_data <- data[1:TRAIN_SIZE,]
```

```{r}
mean <- apply(train_data, 2, mean)
std <- apply(train_data, 2, sd)
pdata <- scale(pdata, center = mean, scale = std)
```

```{r}

```

```{r}

```















